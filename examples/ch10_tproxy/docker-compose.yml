services:
  router:
    image: alpine:latest
    container_name: tproxy_router
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
    volumes:
      - ./tproxy_server.py:/tproxy_server.py:ro
    command: >
      sh -c " apk add --no-cache iproute2 nftables python3 && python3 /tproxy_server.py & tail -f /dev/null "
    networks:
      lan:
        ipv4_address: 10.10.10.254

  client:
    image: alpine:latest
    container_name: tproxy_client
    cap_add:
      - NET_ADMIN
    command: >
      sh -c " apk add --no-cache curl && ip route del default || true && ip route add default via 10.10.10.254 && tail -f /dev/null "
    networks:
      lan:
        ipv4_address: 10.10.10.2
    depends_on:
      - router

networks:
  lan:
    driver: bridge
    ipam:
      config:
        - subnet: 10.10.10.0/24
